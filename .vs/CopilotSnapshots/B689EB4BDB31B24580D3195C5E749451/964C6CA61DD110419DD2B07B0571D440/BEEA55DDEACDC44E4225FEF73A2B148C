using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using CoffeeShopApi.Data;
using CoffeeShopApi.DTOs;
using CoffeeShopApi.Models;
using Microsoft.EntityFrameworkCore;

namespace CoffeeShopApi.Services;

public interface IProductService
{
    Task<IEnumerable<ProductResponse>> GetAllAsync();
    Task<ProductResponse?> GetByIdAsync(int id);
    Task<ProductResponse> CreateAsync(CreateProductRequest request);
    Task<bool> UpdateAsync(int id, UpdateProductRequest request);
    Task<bool> DeleteAsync(int id);
    Task<PaginatedResponse<ProductResponse>> GetPagedAsync(int page, int pageSize,string? search, string? orderBy, string? filter);
}

public class ProductService : IProductService
{
    private readonly AppDbContext _context;

    public ProductService(AppDbContext context)
    {
        _context = context;
    }

    public async Task<IEnumerable<ProductResponse>> GetAllAsync()
    {
        var products = await _context.Products
            .Include(p => p.Category)
            .Include(p => p.ProductDetails)
            .ToListAsync();

        return products.Select(MapToResponse);
    }

    public async Task<ProductResponse?> GetByIdAsync(int id)
    {
        var product = await _context.Products
            .Include(p => p.Category)
            
            .Include(p => p.ProductDetails)
            .FirstOrDefaultAsync(p => p.Id == id);

        return product == null ? null : MapToResponse(product);
    }

    public async Task<ProductResponse> CreateAsync(CreateProductRequest request)
    {           
        // determine category id: support either CategoryId or nested Category { id }
        int? categoryId = request.CategoryId;
        // if request has nested Category object, try reading it via reflection-safe property
        var categoryProp = request.GetType().GetProperty("Category");
        if (categoryId == null && categoryProp != null)
        {
            var catObj = categoryProp.GetValue(request);
            if (catObj != null)
            {
                var idProp = catObj.GetType().GetProperty("Id");
                if (idProp != null)
                {
                    var idVal = idProp.GetValue(catObj);
                    if (idVal is int idInt) categoryId = idInt;
                }
            }
        }

        var details = request.ProductDetails ?? new List<ProductDetailDto>();

        var product = new Product
        {
            Name = request.Name,
            Description = request.Description,
            ImageUrl = request.ImageUrl,
            ProductDetails = details.Select(d => new ProductDetail
            {
                Size = d.Size,
                Price = d.Price,
            }).ToList()
        };

        // If frontend provided CategoryId, validate it and set
        if (categoryId != null)
        {
            var category = await _context.Categories.FindAsync(categoryId.Value);
            if (category == null)
                throw new ArgumentException("Category not found");

            product.CategoryId = category.Id;
            product.Category = category;
        }

        _context.Products.Add(product);
        await _context.SaveChangesAsync();

        // Reload product with related data for response
        var created = await _context.Products
            .Include(p => p.Category)
            .Include(p => p.ProductDetails)
            .FirstOrDefaultAsync(p => p.Id == product.Id);

        if (created == null) throw new InvalidOperationException("Created product not found");

        return MapToResponse(created);
    }

    public async Task<bool> UpdateAsync(int id, UpdateProductRequest request)
    {
        var product = await _context.Products
            .Include(p => p.ProductDetails)
            .FirstOrDefaultAsync(p => p.Id == id);

        if (product == null) return false;

        product.Name = request.Name;
        product.Description = request.Description;
        product.ImageUrl = request.ImageUrl;
        // determine category id (support nested Category object or CategoryId)
        int? updCategoryId = request.CategoryId;
        var categoryProp2 = request.GetType().GetProperty("Category");
        if (updCategoryId == null && categoryProp2 != null)
        {
            var catObj = categoryProp2.GetValue(request);
            if (catObj != null)
            {
                var idProp = catObj.GetType().GetProperty("Id");
                if (idProp != null)
                {
                    var idVal = idProp.GetValue(catObj);
                    if (idVal is int idInt) updCategoryId = idInt;
                }
            }
        }

        if (updCategoryId != null)
        {
            var category = await _context.Categories.FindAsync(updCategoryId.Value);
            if (category == null)
                throw new ArgumentException("Category not found");
            product.CategoryId = category.Id;
            product.Category = category;
        }

        // update details only when provided (if null -> keep existing; if empty list -> clear)
        if (request.ProductDetails != null)
        {
            _context.ProductDetails.RemoveRange(product.ProductDetails);

            foreach (var item in request.ProductDetails)
            {
                product.ProductDetails.Add(new ProductDetail
                {
                    Size = item.Size,
                    Price = item.Price,
                });
            }
        }

        await _context.SaveChangesAsync();
        return true;
    }

    public async Task<bool> DeleteAsync(int id)
    {
        var product = await _context.Products.FindAsync(id);
        if (product == null) return false;
        _context.Products.Remove(product);
        await _context.SaveChangesAsync();
        return true;
    }

    public async Task<PaginatedResponse<ProductResponse>> GetPagedAsync(int page, int pageSize, string? search, string? orderBy, string? filter)
    {
        var query = _context.Products
            .Include(p => p.Category)
            .Include(p => p.ProductDetails)
            .AsQueryable();     
        // Search across name and description
        if (!string.IsNullOrWhiteSpace(search))
        {
            var s = search.Trim();
            query = query.Where(p => p.Name.Contains(s) || (p.Description != null && p.Description.Contains(s)));
        }

        // Filter parsing: support comma separated key:value pairs like "categoryId:3" or "category:Coffee"
        if (!string.IsNullOrWhiteSpace(filter))
        {
            var parts = filter.Split(',', StringSplitOptions.RemoveEmptyEntries);
            foreach (var part in parts)
            {
                var kv = part.Split(':', 2);
                if (kv.Length != 2) continue;
                var key = kv[0].Trim().ToLowerInvariant();
                var val = kv[1].Trim();
                if (string.IsNullOrEmpty(val)) continue;

                if (key == "categoryid" && int.TryParse(val, out var cid))
                {
                    query = query.Where(p => p.CategoryId == cid);
                }
                else if (key == "category")
                {
                    query = query.Where(p => p.Category != null && p.Category.Name.Contains(val));
                }
                else if (key == "id" && int.TryParse(val, out var id))
                {
                    query = query.Where(p => p.Id == id);
                }
            }
        }

        // Order by: support id, name, and category (by category name)
        // Syntax: "id", "-id", "id:desc", "id desc", "id asc"
        if (!string.IsNullOrWhiteSpace(orderBy))
        {
            var ord = orderBy.Trim();
            bool desc = false;
            
            // Check for prefix "-" (e.g., "-id")
            if (ord.StartsWith("-"))
            {
                desc = true;
                ord = ord.Substring(1).Trim();
            }
            else
            {
                // Check for space separator (e.g., "id desc" or "id asc")
                var spaceParts = ord.Split(new[] { ' ' }, 2, StringSplitOptions.RemoveEmptyEntries);
                if (spaceParts.Length == 2)
                {
                    ord = spaceParts[0].Trim();
                    var direction = spaceParts[1].Trim();
                    if (direction.Equals("desc", StringComparison.OrdinalIgnoreCase))
                        desc = true;
                    else if (direction.Equals("asc", StringComparison.OrdinalIgnoreCase))
                        desc = false;
                }
                else
                {
                    // Check for colon separator (e.g., "id:desc" or "id:asc")
                    var colonParts = ord.Split(':', 2);
                    if (colonParts.Length == 2)
                    {
                        ord = colonParts[0].Trim();
                        var direction = colonParts[1].Trim();
                        if (direction.Equals("desc", StringComparison.OrdinalIgnoreCase))
                            desc = true;
                        else if (direction.Equals("asc", StringComparison.OrdinalIgnoreCase))
                            desc = false;
                    }
                }
            }
            
            var field = ord.Trim();
            
            if (field.Equals("id", StringComparison.OrdinalIgnoreCase))
                query = desc ? query.OrderByDescending(p => p.Id) : query.OrderBy(p => p.Id);
            else if (field.Equals("name", StringComparison.OrdinalIgnoreCase))
                query = desc ? query.OrderByDescending(p => p.Name) : query.OrderBy(p => p.Name);
            else if (field.Equals("category", StringComparison.OrdinalIgnoreCase))
                query = desc ? query.OrderByDescending(p => p.Category != null ? p.Category.Name : string.Empty)
                             : query.OrderBy(p => p.Category != null ? p.Category.Name : string.Empty);
        }

        var totalCount = await query.CountAsync();

        var items = await query
            .Skip((Math.Max(1, page) - 1) * Math.Max(1, pageSize))
            .Take(Math.Max(1, pageSize))
            .ToListAsync();

        var mapped = items.Select(MapToResponse).ToList();

        return new PaginatedResponse<ProductResponse>(mapped, totalCount, Math.Max(1, page), Math.Max(1, pageSize));
    }

    private static ProductResponse MapToResponse(Product product)
    {
        return new ProductResponse
        {
            Id = product.Id,
            Name = product.Name,
            Description = product.Description,
            ImageUrl = product.ImageUrl,
            Category = product.Category == null ? null : new CategoryResponse
            {
                Id = product.Category.Id,
                Name = product.Category.Name
            },
            ProductDetails = product.ProductDetails.Select(d => new ProductDetailResponse
            {
                Id = d.Id,
                Size = d.Size,
                Price = d.Price
            }).ToList()
        };
    }
}