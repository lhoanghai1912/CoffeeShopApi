using CoffeeShopApi.Data;
using CoffeeShopApi.DTOs;
using CoffeeShopApi.Models;
using Microsoft.EntityFrameworkCore;

namespace CoffeeShopApi.Services;

public interface ICategoryservice
{
    CategoryResponse? ToCategoryResponse(Category? Category);
    
    Task<IEnumerable<CategoryResponse>> GetAllAsync();
    Task<CategoryResponse?> GetByIdAsync(int id);
    Task<CategoryResponse> CreateAsync(CreateCategoryRequest request);
    Task<bool> UpdateAsync(int id, UpdateCategoryRequest request);
    Task<bool> DeleteAsync(int id);
    Task<PagedResult<CategoryResponse>> GetPagedAsync(int page, int pageSize,string? search, string? orderBy, string? filter);

}

public class CategoriesService : ICategoryservice
{
    private readonly AppDbContext _context;

    public CategoriesService(AppDbContext context)
    {
        _context = context;
    }

        private static IQueryable<T> ApplyOrdering<T, TKey>(IQueryable<T> source, System.Linq.Expressions.Expression<Func<T, TKey>> keySelector, bool desc, bool first)
        {
            if (first)
            {
                return desc ? source.OrderByDescending(keySelector) : source.OrderBy(keySelector);
            }
            else
            {
                var ordered = source as IOrderedQueryable<T>;
                if (ordered == null)
                    return desc ? source.OrderByDescending(keySelector) : source.OrderBy(keySelector);
                return desc ? ordered.ThenByDescending(keySelector) : ordered.ThenBy(keySelector);
            }
        }
    
    public async Task<IEnumerable<CategoryResponse>> GetAllAsync()
    {
        var Categories = await _context.Categories.ToListAsync();
        return Categories.Select(MapToResponse);
    }

    public CategoryResponse? ToCategoryResponse(Category? Category)
    {
        if (Category == null) return null;
        return new CategoryResponse
        {
            Id = Category.Id,
            Name = Category.Name
        };
    }

    private static CategoryResponse MapToResponse(Category Category)
    {
        return new CategoryResponse
        {
            Id = Category.Id,
            Name = Category.Name
        };
    }

    public async Task<CategoryResponse?> GetByIdAsync(int id)
    {
        var Category = await _context.Categories.FindAsync(id);
        return Category == null ? null : MapToResponse(Category);
    }

    public async Task<CategoryResponse> CreateAsync(CreateCategoryRequest request)
    {
        var Category = new Category
        {
            Name = request.Name
        };
        _context.Categories.Add(Category);
        await _context.SaveChangesAsync();
        return MapToResponse(Category);
    }

    public async Task<bool> UpdateAsync(int id, UpdateCategoryRequest request)
    {
        var Category = await _context.Categories.FindAsync(id);
        if (Category == null) return false;
        Category.Name = request.Name;
        await _context.SaveChangesAsync();
        return true;
    }

    public async Task<bool> DeleteAsync(int id)
    {
        var Category = await _context.Categories.FindAsync(id);
        if (Category == null) return false;
        _context.Categories.Remove(Category);
        await _context.SaveChangesAsync();
        return true;
    }

    public async Task<PagedResult<CategoryResponse>> GetPagedAsync(int page, int pageSize, string? search, string? orderBy, string? filter)
    {
        var query = _context.Categories.AsQueryable();

        // search
        if (!string.IsNullOrWhiteSpace(search))
        {
            var s = search.Trim();
            query = query.Where(c => c.Name.Contains(s));
        }

        // filter: support id or name filters e.g. "id:1" or "name:Coffee"
        if (!string.IsNullOrWhiteSpace(filter))
        {
            var parts = filter.Split(',', StringSplitOptions.RemoveEmptyEntries);
            foreach (var part in parts)
            {
                var kv = part.Split(':', 2);
                if (kv.Length != 2) continue;
                var key = kv[0].Trim().ToLowerInvariant();
                var val = kv[1].Trim();
                if (key == "id" && int.TryParse(val, out var id))
                    query = query.Where(r => r.Id == id);
                else if (key == "name")
                    query = query.Where(r => r.Name.Contains(val));
            }
        }

        // orderBy - support multiple fields like "name,-id"
        if (!string.IsNullOrWhiteSpace(orderBy))
        {
            var orders = orderBy.Split(',', StringSplitOptions.RemoveEmptyEntries).Select(o => o.Trim());
            bool first = true;
            foreach (var ord in orders)
            {
                var token = ord;
                bool desc = false;
                if (token.StartsWith("-")) { desc = true; token = token.Substring(1); }
                var kv = token.Split(':', 2);
                var field = kv[0].Trim().ToLowerInvariant();
                if (kv.Length == 2 && kv[1].Trim().Equals("desc", StringComparison.OrdinalIgnoreCase)) desc = true;

                if (field == "name")
                {
                    query = ApplyOrdering(query, c => c.Name, desc, first);
                }
                else if (field == "id")
                {
                    query = ApplyOrdering(query, c => c.Id, desc, first);
                }

                first = false;
            }
        }

        return await PaginationHelper.PaginateAsync(query, page, pageSize, MapToResponse);
    }
}
