using CoffeeShopApi.Data;
using CoffeeShopApi.DTOs;
using CoffeeShopApi.Models;
using Microsoft.EntityFrameworkCore;

namespace CoffeeShopApi.Services;

public interface ICategoryservice
{
    CategoryResponse? ToCategoryResponse(Category? Category);
    
    Task<IEnumerable<CategoryResponse>> GetAllAsync();
    Task<CategoryResponse?> GetByIdAsync(int id);
    Task<CategoryResponse> CreateAsync(CreateCategoryRequest request);
    Task<bool> UpdateAsync(int id, UpdateCategoryRequest request);
    Task<bool> DeleteAsync(int id);
    Task<PagedResult<CategoryResponse>> GetPagedAsync(int page, int pageSize,string? search, string? orderBy, string? filter);

}



public class CategoriesService : ICategoryservice
{
    private readonly AppDbContext _context;

    public CategoriesService(AppDbContext context)
    {
        _context = context;
    }
    
    public async Task<IEnumerable<CategoryResponse>> GetAllAsync()
    {
        var Categories = await _context.Categories.ToListAsync();
        return Categories.Select(MapToResponse);
    }

    public async Task<PagedResult<ProductResponse>> GetPagedAsync(int page, int pageSize, string? search, string? orderBy, string? filter)
    {
        var query = _context.Products
            .Include(p => p.Category)
            .Include(p => p.ProductDetails)
            .AsQueryable();     

        // Lọc theo tên sản phẩm
        if (!string.IsNullOrEmpty(filter))
        {
            query = query.Where(p => p.Name.Contains(filter));
        }

        // Sắp xếp
        if (!string.IsNullOrEmpty(orderBy))
        {
            if (orderBy.Equals("name", StringComparison.OrdinalIgnoreCase))
                query = query.OrderBy(p => p.Name);
            else if (orderBy.Equals("category", StringComparison.OrdinalIgnoreCase))
                query = query.OrderBy(p => p.Category);
        }

        var totalRecords = await query.CountAsync();

        var items = await query
            .Skip((page - 1) * pageSize)
            .Take(pageSize)
            .ToListAsync();

        return new PagedResult<ProductResponse>
        {
            Page = page,
            PageSize = pageSize,
            TotalRecords = totalRecords,
            Items = items.Select(MapToResponse)
        };
    }
    
    public CategoryResponse? ToCategoryResponse(Category? Category)
    {
        if (Category == null) return null;
        return new CategoryResponse
        {
            Id = Category.Id,
            Name = Category.Name
        };
    }

    private static CategoryResponse MapToResponse(Category Category)
    {
        return new CategoryResponse
        {
            Id = Category.Id,
            Name = Category.Name
        };
    }

    public async Task<CategoryResponse?> GetByIdAsync(int id)
    {
        var Category = await _context.Categories.FindAsync(id);
        return Category == null ? null : MapToResponse(Category);
    }

    public async Task<CategoryResponse> CreateAsync(CreateCategoryRequest request)
    {
        var Category = new Category
        {
            Name = request.Name
        };
        _context.Categories.Add(Category);
        await _context.SaveChangesAsync();
        return MapToResponse(Category);
    }

    public async Task<bool> UpdateAsync(int id, UpdateCategoryRequest request)
    {
        var Category = await _context.Categories.FindAsync(id);
        if (Category == null) return false;
        Category.Name = request.Name;
        await _context.SaveChangesAsync();
        return true;
    }

    public async Task<bool> DeleteAsync(int id)
    {
        var Category = await _context.Categories.FindAsync(id);
        if (Category == null) return false;
        _context.Categories.Remove(Category);
        await _context.SaveChangesAsync();
        return true;
    }

    // public async Task<PagedResult<CategoryResponse>> GetPagedAsync(int page, int pageSize, string? search, string? orderBy, string? filter)
    // {
    //     var query = _context.Categories.AsQueryable();
    //     if (!string.IsNullOrEmpty(filter))
    //         query = query.Where(r => r.Name.Contains(filter) );
    //
    //     if (!string.IsNullOrEmpty(orderBy))
    //     {
    //         if (orderBy.Equals("name", StringComparison.OrdinalIgnoreCase))
    //             query = query.OrderBy(r => r.Name);
    //     }
    //
    //     var total = await query.CountAsync();
    //     var items = await query.Skip((page - 1) * pageSize).Take(pageSize).ToListAsync();
    //
    //     return new PagedResult<CategoryResponse>
    //     {
    //         Page = page,
    //         PageSize = pageSize,
    //         TotalRecords = total,
    //         Items = items.Select(MapToResponse)
    //     };
    // }
}
